# 結帳系統快速設定指南

## ✅ 問題已解決

您原本遇到的問題：
- ❌ 下單後沒有付款方式選擇
- ❌ 強制跳轉藍新金流顯示「信用卡未啟動」
- ❌ 跳轉到錯誤頁面「資料驗證失敗」

現在已經全部修復！

---

## 🎯 修改內容

### 1. 結帳頁面已升級

**新增功能：**
- ✅ **三種付款方式選擇**：
  - 貨到付款（預設，最安全）
  - 銀行轉帳
  - 線上支付（藍新金流）
- ✅ 完整的收件地址表單
- ✅ 優惠券使用
- ✅ 購物金折抵（會員專享）

**檔案位置：** `app/checkout/page.tsx`

### 2. 環境變數已配置

已創建 `.env.local` 文件，包含您的藍新金流憑證：
- HashKey: ✅ 已設定
- HashIV: ✅ 已設定

### 3. 完整設定文檔

詳細的藍新金流設定說明：`docs/NEWEBPAY_SETUP.md`

---

## 🚀 立即開始使用

### 步驟 1：完成環境變數設定

編輯 `.env.local` 文件，補充您的商店代號：

```env
# 請替換為您的藍新金流商店代號
NEWEBPAY_MERCHANT_ID=MS12345678
```

### 步驟 2：啟動開發伺服器

```bash
npm run dev
# 或
pnpm dev
```

### 步驟 3：測試結帳流程

1. 訪問 http://localhost:3000
2. 加入商品到購物車
3. 前往結帳頁面
4. **選擇付款方式**：
   - 選擇「貨到付款」→ 直接完成訂單 ✅
   - 選擇「銀行轉帳」→ 直接完成訂單 ✅
   - 選擇「線上支付」→ 跳轉到藍新金流 💳

---

## 💡 付款方式說明

### 1. 貨到付款（推薦新手測試）

- ✅ **最簡單**：不需要藍新金流設定
- ✅ **即時完成**：訂單立即建立
- 💰 手續費：NT$60

**適用場景：**
- 測試訂單流程
- 不想設定藍新金流
- 客戶喜歡現金交易

### 2. 銀行轉帳

- ✅ **簡單**：不需要藍新金流設定
- ✅ **即時完成**：訂單立即建立
- 📧 後續需提供匯款資訊給客戶

**適用場景：**
- 大額訂單
- 企業客戶

### 3. 線上支付（藍新金流）

- 💳 **功能最完整**：支援信用卡、ATM、超商
- ⚙️ **需要設定**：需完成藍新金流商店後台設定
- ⚡ **即時到帳**：付款後立即確認訂單

**適用場景：**
- 正式營運
- 需要自動化處理付款

---

## ⚠️ 重要提醒

### 如果您要使用藍新金流「線上支付」

請完成以下設定（否則會出現錯誤）：

#### 1. 設定商店代號

```env
# .env.local
NEWEBPAY_MERCHANT_ID=您的商店代號
```

#### 2. 到藍新金流商店後台啟用支付方式

登入 https://cwww.newebpay.com/（測試環境）

進入「商店管理」→「收款管理」，**啟用**：
- ✅ 信用卡
- ✅ ATM 轉帳
- ✅ 超商代碼

⚠️ **如果未啟用信用卡**，會出現「信用卡未啟動」錯誤！

#### 3. 本地測試限制

藍新金流**無法呼叫 localhost 回調網址**。

**解決方案 A：使用 ngrok**

```bash
# 安裝 ngrok
npm install -g ngrok

# 啟動 ngrok
ngrok http 3000

# 複製 ngrok 網址（如：https://abc123.ngrok.io）
# 更新 .env.local 的回調網址
```

**解決方案 B：先測試其他付款方式**

測試階段先使用「貨到付款」或「銀行轉帳」，等部署到正式伺服器再測試藍新金流。

---

## 📱 用戶體驗流程

### 流程 A：貨到付款/銀行轉帳

```
加入購物車 → 結帳 → 填寫資料 → 選擇付款方式 → 確認訂單 → 訂單完成 ✅
```

### 流程 B：線上支付（藍新金流）

```
加入購物車 → 結帳 → 填寫資料 → 選擇「線上支付」 → 跳轉藍新金流 → 選擇支付方式（信用卡/ATM/超商）→ 完成付款 → 返回網站 → 訂單完成 ✅
```

---

## 🔍 問題排查

### 問題：選擇線上支付後出現「信用卡未啟動」

**解決方案：**
1. 到藍新金流商店後台啟用信用卡功能
2. 或者在程式碼中移除信用卡選項（只保留 ATM 和超商）

修改 `app/api/newebpay/create-payment/route.ts`：

```typescript
paymentTypes: ['VACC', 'CVS'], // 移除 'CREDIT_CARD'
```

### 問題：資料驗證失敗

**解決方案：**
檢查 `.env.local` 的 HashKey 和 HashIV 是否正確：

```env
NEWEBPAY_HASH_KEY=K9gJ99V7agH7IHzXFrQMQQWHKgW6LDZd
NEWEBPAY_HASH_IV=P3Byvs1dzveFaSLC
```

### 問題：訂單狀態沒有更新

**原因：** 本地環境藍新金流無法呼叫回調網址

**解決方案：**
- 使用 ngrok 建立公開網址
- 或部署到測試伺服器

---

## 📚 更多資訊

- 完整設定指南：`docs/NEWEBPAY_SETUP.md`
- 藍新金流技術文件：https://www.newebpay.com/website/Page/content/download_api
- 客服電話：02-2655-5658

---

## ✨ 功能特色

### 會員專享

- 💰 購物金折抵
- 🎁 訂單累積積分
- 📦 訂單歷史查詢

### 所有用戶

- 🎫 優惠券使用
- 🚚 免運費
- 🛡️ 安全加密結帳
- 📱 手機友善介面

---

**最後更新：** 2024年11月16日  
**版本：** v2.0 - 完整付款方式支援

